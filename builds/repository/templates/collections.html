{% extends 'base.html' %}
{% block title %}GDSC{% endblock %}
{% block head %}
    {{ super() }}
    <style>
      .btn-link.btn-anchor {
          outline: none !important;
          padding: 0;
          border: 0;
          vertical-align: baseline;
      }
      .btn-link.btn-anchor:focus {
          box-shadow: none !important;
      }
    </style>
{% endblock %}

{% block content %}
  <div class="row mb-4">
    <div class="col">
      <h2 class="mb-1">
        {{ collections[collection]['Title'][0] }}
      </h2>
      <p class="mb-0">
        {% autoescape off %}{{ collections[collection]['Description'][0] }}{% endautoescape %}
      </p>

      {% if collections[collection]['Creator'] %}
        <p class="mb-0"><b>Contributors:</b></p>
        <div class="container mb-0">
          {% for contributor in collections[collection]['Creator'][0].split('|') %}
            {% set contributor = contributor.split(';') %}
            <p class="mb-0">
              {{ contributor[0] }}{% if contributor[7] %}, {{ contributor[7] }}{% endif %}
              {% if contributor[4] %}, <a href="{{ contributor[4] }}" target="_blank">{{ contributor[4] }}</a>{% endif %}
            </p>
          {% endfor %}
        </div>
      {% endif %}

      {% if collections[collection]['Relations'] %}
      <p class="mb-0"><b>Related Content:</b></p>
      <div class="container mb-0">
        {% for relation in collections[collection]['Relations'][0].split('|') %}
          {% set relationship = relation.split(';') %}
          <p class="mb-0">
            The <a href="{{ relationship[2] }}" target="_blank">{{ relationship[0] }}</a>
            {{ relationship[1].lower() }} this collection.
          </p>
        {% endfor %}
      </div>
      {% endif %}

      {% if collections[collection]['Coverage'] %}
      <p class="mb-0"><b>Geographical coverage:</b></p>
      <div class="container mb-0">
        {% for coverage in collections[collection]['Coverage'][0].split('|') %}
          {% set coverage = coverage.split(';') %}
          <p class="mb-0">
            {% if coverage[1] == 'gazeteer' %}
              <a href="{{ coverage[2] }}" target="_blank">{{ coverage[0] }}</a>
            {% endif %}
          </p>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="row border rounded p-4">
    <div class="col-3">
      <form method="get" id="filterForm" name="filterForm" class="w-100">
        <input type="hidden" name="page" value="{{ page }}">
        <input type="hidden" name="collection" value="{{ collection_arg }}">
        <div class="flex flex-col space-y-2">
          {% for coll in collections %}
            <a href="javascript:void(0);" 
              class="row p-1 ml-1 mr-1 hover:bg-gray-100 {{ 'font-bold' if collection == collections[coll]['Collection_ID'][0] else '' }}"
              onclick="updateCollection('{{ collections[coll]['Collection_ID'][0] }}')">
              {{ collections[coll]['Title'][0] }}
            </a>

            <script>
            function updateCollection(value) {
              const form = document.getElementById("filterForm");
              const input = form.querySelector("input[name=collection]");
              input.value = value;
              form.submit();
            }
            </script>
          {% endfor %}
        </div>

        <div class="mt-3">
          <input type="checkbox"
                 {{ "checked" if active == 'true' else "" }}
                 id="active"
                 name="active"
                 value="true"
                 class="ml-1"
                 onchange="this.form.submit()">
          <label for="active" class="ml-1">
            show only active datasets
          </label>
        </div>
      </form>
    </div>
    <div class="col-9">
      <div class="row mb-4 align-items-center justify-content-between">
        <div class="col-auto float-left">
          <button type="submit" class="btn btn-primary" form="filterForm">Search</button>
        </div>

        <div class="col-auto float-left">
          <input type="text" class="form-control" name="searchTerm" form="filterForm"
            placeholder="Enter search term(s)"
            value="{{ search_term_arg }}"
            style="width: auto; min-width: 200px;">
        </div>
        <div class="col"></div>

        <div class="col-auto float-right">
          <a href="{{ switch_url }}" class="btn btn-outline-secondary">
            {{ switch_label }}
          </a>
        </div>
      </div>
      
      <div class="row mb-2 m-0">
        <nav aria-label="Page navigation example">
          <ul class="pagination">
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
              <button type="submit" class="page-link" form="filterForm" onclick="setPage({{ page-1 }})">
                <span aria-hidden="true">&laquo;</span>
              </button>
            </li>
            {% for i in range(numresults//10 + 1) %}
            <li class="page-item {% if page == i + 1 %}active{% endif %}">
              <button type="submit" class="page-link" form="filterForm" onclick="setPage({{ i+1 }})">
                {{i+1}}
              </button>
            </li>
            {% endfor %}
            <li class="page-item {% if page == numresults//10 %}disabled{% endif %}">
              <button type="submit" class="page-link" form="filterForm" onclick="setPage({{ page+1 }})">
                <span aria-hidden="true">&raquo;</span>
              </button>
            </li>
          </ul>
        </nav>

        <script>
          function setPage(value) {
            const form = document.getElementById("filterForm");
            form.querySelector("input[name=page]").value = value;
            form.submit();
          }
        </script>
      </div>

      {% if results and results|length > 0 %}
      <div class="row mb-4 m-0">
        <h5 class="float-left mb-1">Datasets in collection ({{ numresults }}):</h5>
        <div class="col ml-4 pr-0 dropdown">
          <button class="btn btn-success float-right dropdown-toggle" data-bs-toggle="dropdown" type="button" aria-expanded="true">
            Download Citations
          </button>
          <ul class="dropdown-menu pt-0 pb-0">
            <li class="dropdown-item p-0">
              <a href="cite?format=bibtex&collection={{collection}}" class="btn">
                BibTeX
              </a>
            </li>
            <li class="dropdown-item p-0">
              <a href="cite?format=ris&collection={{collection}}" class="btn">
                RIS
              </a>
            </li>
          </ul>
        </div>
      </div>
      {% for document in results %}
        {% autoescape off %}
        <div class="row mb-4 border rounded p-4 m-0">
          <div class="col ml-4">

            <h4 class="float-left">
              {% if document['adms_representationTechnique'] %}
                {% if document['adms_representationTechnique'][0] == 'raster' %}
                  <img src="/static/raster.jpg" class="mb-1" style="max-width: 18px;">
                {% else %}
                  {% if document['locn_geometry'] %}
                    <img src="/static/{{ document['locn_geometry'][0] }}.jpg" class="mb-1" style="max-width: 18px;">
                  {% endif %}
                {% endif %}
              {% endif %}
            </h4>

            <div class="container">
              <div class="row">
                <div class="col">
                    {% if document['dct_creator'] %}
                      {% for creator in document['dct_creator'] %}
                        {% set creator = creator.split(';') %}
                        {{ creator[0] }}{{ ", " if not loop.last else "" }}
                      {% endfor %}
                    {% endif %}
                    {% if document['dct_issued'] %}({{ document['dct_issued'][0][:4] }}){% endif %}.
                    {% if document['dct_title'] %}{{ document['dct_title'][0] }}{% endif %} [gis dataset].
                    {% if document['dct_publisher'] %}{{ document['dct_publisher'][0] }}{% endif %}.
                    {% if document['dct_identifier'] %}<a href="{{ document['dct_identifier'][0] }}" target="_blank" class="text-wrap text-break">{{ document['dct_identifier'][0] }}</a>.{% endif %}

                  {% if document['found_in'] and document['found_in']['gdsc_attributes'] %}
                  <span class="mt-1 d-block"><b>Attributes with <span class="highlight-term">{{ query }}</span>:</b>
                    {% for attr in document['found_in']['gdsc_attributes'] %}
                      {{ attr[0] }}{{ ", " if not loop.last else "" }}
                    {% endfor %}
                  </span>
                  {% endif %}
                </div>
                <div class="dropdown">
                  <button class="btn btn-link p-1 dropdown-toggle"  data-bs-toggle="dropdown" type="button" aria-expanded="true">
                    Cite
                  </button>
                  <ul class="dropdown-menu p-1" style="width: auto; min-width: 0">
                    <li>
                      <a class="dropdown-item p-1" href="cite?format=bibtex&name_id={{document['gdsc_tablename'][0]}}&collection={{collection}}">
                          BibTeX
                        </a>
                    </li>
                    <li>
                      <a class="dropdown-item p-1" href="cite?format=ris&name_id={{document['gdsc_tablename'][0]}}&collection={{collection}}">
                          RIS
                        </a>
                    </li>
                  </ul>
                </div>

              </div>
            </div>
          </div>
        </div>
        {% endautoescape %}
      {% endfor %}
      <div class="row mb-2 m-0">
        <nav aria-label="Page navigation example">
          <ul class="pagination">
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
              <button type="submit" class="page-link" form="filterForm" name="page" value="{{ page - 1 }}">
                <span aria-hidden="true">&laquo;</span>
              </button>
            </li>
            {% for i in range(numresults//10 + 1) %}
            <li class="page-item {% if page == i + 1 %}active{% endif %}">
              <button type="submit" class="page-link" form="filterForm" name="page" value="{{ i + 1 }}">
                {{i+1}}
              </button>
            </li>
            {% endfor %}
            <li class="page-item {% if page == numresults//10 %}disabled{% endif %}">
              <button type="submit" class="page-link" form="filterForm" name="page" value="{{ page + 1 }}">
                <span aria-hidden="true">&raquo;</span>
              </button>
            </li>
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
