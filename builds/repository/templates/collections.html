{% extends 'base.html' %}
{% block title %}GDSC{% endblock %}
{% block head %}
    {{ super() }}
    <style>
      .btn-link.btn-anchor {
          outline: none !important;
          padding: 0;
          border: 0;
          vertical-align: baseline;
      }
      .btn-link.btn-anchor:focus {
          box-shadow: none !important;
      }
    </style>
{% endblock %}

{% block content %}
  <div class="container mb-5">
    <div class="row border-top border-bottom pt-2 pb-2">
      <form method="post" id="filterForm" name="filterForm" class="w-100">
        <div class="d-flex justify-content-between w-auto">
          <!-- toggle button back to index (home) -->
          <div>
            <a href="{{ switch_url }}" class="btn btn-outline-secondary float-right mb-2">
              {{ switch_label }}
            </a>
          </div>
          <div>
            <button type="submit" class="float-right btn btn-primary">Search</button>
          </div>
          <div>
            <input type="text" class="form-control" name="searchTerm" placeholder="Enter search term(s)"
              value="{{ query if (query != '' and query is not none) else '' }}">
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="mb-5">
    <h2 class="mb-1">
      {{ collections[collection]['Title'][0] }}
    </h2>
    <p class="mb-0">
      {% autoescape off %}{{ collections[collection]['Description'][0] }}{% endautoescape %}
    </p>

    {% if collections[collection]['Creator'] %}
      <p class="mb-0"><b>Contributors:</b></p>
      <div class="container mb-0">
        {% for contributor in collections[collection]['Creator'][0].split('|') %}
          {% set contributor = contributor.split(';') %}
          <p class="mb-0">
            {{ contributor[0] }}{% if contributor[7] %}, {{ contributor[7] }}{% endif %}
            {% if contributor[4] %}, <a href="{{ contributor[4] }}" target="_blank">{{ contributor[4] }}</a>{% endif %}
          </p>
        {% endfor %}
      </div>
    {% endif %}

    {% if collections[collection]['Relations'] %}
    <p class="mb-0"><b>Related Content:</b></p>
    <div class="container mb-0">
      {% for relation in collections[collection]['Relations'][0].split('|') %}
        {% set relationship = relation.split(';') %}
        <p class="mb-0">
          The <a href="{{ relationship[2] }}" target="_blank">{{ relationship[0] }}</a>
          {{ relationship[1].lower() }} this collection.
        </p>
      {% endfor %}
    </div>
    {% endif %}

    {% if collections[collection]['Coverage'] %}
    <p class="mb-0"><b>Geographical coverage:</b></p>
    <div class="container mb-0">
      {% for coverage in collections[collection]['Coverage'][0].split('|') %}
        {% set coverage = coverage.split(';') %}
        <p class="mb-0">
          {% if coverage[1] == 'gazeteer' %}
            <a href="{{ coverage[2] }}" target="_blank">{{ coverage[0] }}</a>
          {% endif %}
        </p>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <div class="container mb-4">
    <div class="row">
      <div class="col-3">
        <div>
          <select class="form-control" id="collection" name="collection">
            {% for coll in collections %}
            <option value="{{ collections[coll]['Collection_ID'][0] }}"
              {{ "selected='selected'" if collection == collections[coll]['Collection_ID'][0] else "" }}>
              {{ collections[coll]['Title'][0] }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <input type="checkbox" {{ "checked" if active == 'true' else "" }} id="active" name="active" value="true" class="ml-3 mt-3">
          <label for="active">
            show only active datasets
          </label>
        </div>
      </div>
      <div class="col">
        {% if results and results|length > 0 %}
        <div class="row mb-4">
          <h5 class="float-left mb-1">Datasets in collection ({{ numresults }}):</h5>
          <div class="col ml-4">
            <a href="bibtex_collection/{{collection}}" class="btn btn-success">
              Download Citations (BibTeX)
            </a>
          </div>
        </div>
        {% for document in results %}
          {% autoescape off %}
          <div class="row mb-4 border border-dark rounded-3 p-4">
            <div class="col ml-4">

              <h4 class="float-left">
                {% if document['adms_representationTechnique'] %}
                  {% if document['adms_representationTechnique'][0] == 'raster' %}
                    <img src="/static/raster.jpg" class="mb-1" style="max-width: 18px;">
                  {% else %}
                    {% if document['locn_geometry'] %}
                      <img src="/static/{{ document['locn_geometry'][0] }}.jpg" class="mb-1" style="max-width: 18px;">
                    {% endif %}
                  {% endif %}
                {% endif %}
              </h4>

              <div class="container">
                <div class="row">
                  <div class="col-sm-10">
                      {% if document['dct_creator'] %}
                        {% for creator in document['dct_creator'] %}
                          {% set creator = creator.split(';') %}
                          {{ creator[0] }}{{ ", " if not loop.last else "" }}
                        {% endfor %}
                      {% endif %}
                      {% if document['dct_issued'] %}({{ document['dct_issued'][0][:4] }}){% endif %}.
                      {% if document['dct_title'] %}{{ document['dct_title'][0] }}{% endif %} [gis dataset].
                      {% if document['dct_publisher'] %}{{ document['dct_publisher'][0] }}{% endif %}.
                      {% if document['dct_identifier'] %}<a href="{{ document['dct_identifier'][0] }}" target="_blank" class="text-wrap text-break">{{ document['dct_identifier'][0] }}</a>.{% endif %}
                      <!-- {% if document['dcat_downloadURL'] %} from <a href="{{ document['dcat_downloadURL'][0] }}" target="_blank" class="text-wrap text-break">{{ document['dcat_downloadURL'][0] }}</a>{% endif %} -->

                    {% if document['found_in'] and document['found_in']['gdsc_attributes'] %}
                    <span class="mt-1 d-block"><b>Attributes with <span class="highlight-term">{{ query }}</span>:</b>
                      {% for attr in document['found_in']['gdsc_attributes'] %}
                        {{ attr[0] }}{{ ", " if not loop.last else "" }}
                      {% endfor %}
                    </span>
                    {% endif %}
                  </div>

                  <h4 class="float-left">
                    <div class="download-citation float-right">
                    {% if 'dct_identifier' in document and document['dct_identifier'] %}
                    <a href="bibtex/{{document['gdsc_tablename'][0]}}"
                         class="btn btn-secondary btn-sm ml-2" download>
                          Download Citation (BibTeX)
                      </a>
                    {% endif %}
                    </div>
                  </h4>

                </div>
              </div>
            </div>
          </div>
          {% endautoescape %}
        {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    document.getElementById("collection").addEventListener("change", () => {
      document.getElementById("filterForm").submit();
    });
    document.getElementById("active").addEventListener("change", () => {
      document.getElementById("filterForm").submit();
    });
  </script>
{% endblock %}
